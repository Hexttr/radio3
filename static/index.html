<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="data:,">
  <title>NAVO RADIO</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      color: #e8e8e8;
    }
    .container {
      text-align: center;
      padding: 1.5rem 2rem;
      width: 100%;
      max-width: 900px;
    }
    .eq-wrap {
      width: 100%;
      align-self: stretch;
      position: relative;
    }
    h1 {
      font-size: 3.5rem;
      font-weight: 700;
      margin: 0 0 2rem;
      letter-spacing: 0.15em;
      color: #a855f7;
      text-shadow: 0 0 30px rgba(168, 85, 247, 0.4);
    }
    .eq-wrap {
      position: relative;
      width: 100%;
      height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 1.5rem;
    }
    .equalizer {
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: 3px;
      width: 100%;
      height: 80px;
      padding: 0 2rem;
    }
    .eq-bar {
      flex: 1;
      min-width: 6px;
      max-width: 24px;
      height: 8px;
      background: linear-gradient(to top, #7c3aed, #a855f7);
      border-radius: 4px 4px 0 0;
      transition: height 0.05s ease-out;
    }
    .play-btn {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 72px;
      height: 72px;
      border: none;
      border-radius: 50%;
      background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(168, 85, 247, 0.5), 0 0 0 4px rgba(168, 85, 247, 0.2);
      transition: transform 0.2s, box-shadow 0.2s;
      z-index: 2;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .play-btn:hover {
      transform: translate(-50%, -50%) scale(1.08);
      box-shadow: 0 6px 28px rgba(168, 85, 247, 0.6);
    }
    .play-btn:active {
      transform: translate(-50%, -50%) scale(0.98);
    }
    .now-playing {
      font-size: 0.95rem;
      opacity: 0.9;
      min-height: 1.4em;
    }
    .now-playing .label { color: #a78bfa; }
  </style>
</head>
<body>
  <div class="container">
    <h1>NAVO RADIO</h1>
  </div>
  <div class="eq-wrap">
    <div class="equalizer" id="equalizer"></div>
    <button id="playBtn" class="play-btn" title="Включить">▶</button>
  </div>
  <div class="container">
    <p id="nowPlaying" class="now-playing"><span class="label">Сейчас играет</span> — нажмите Play</p>
  </div>
  <script>
    const playBtn = document.getElementById('playBtn');
    const nowPlaying = document.getElementById('nowPlaying');
    const equalizer = document.getElementById('equalizer');

    const BAR_COUNT = 32;
    let playing = false;
    let muted = false;
    let currentAudio = null;
    let preloaded = null;
    let audioContext = null;
    let analyser = null;
    let currentSource = null;
    let animationId = null;

    // Создаём полоски эквалайзера
    for (let i = 0; i < BAR_COUNT; i++) {
      const bar = document.createElement('div');
      bar.className = 'eq-bar';
      bar.dataset.i = i;
      equalizer.appendChild(bar);
    }
    const bars = equalizer.querySelectorAll('.eq-bar');

    function setNowPlaying(segmentType, artist, title) {
      const label = nowPlaying.querySelector('.label');
      if (segmentType === 'track' && artist && title) {
        label.textContent = 'Сейчас играет';
        nowPlaying.innerHTML = '<span class="label">Сейчас играет</span> — ' + (artist + ' — ' + title);
      } else if (segmentType === 'news') {
        nowPlaying.innerHTML = '<span class="label">Сейчас играет</span> — Новости';
      } else if (segmentType === 'weather') {
        nowPlaying.innerHTML = '<span class="label">Сейчас играет</span> — Погода';
      } else if (segmentType === 'dj') {
        nowPlaying.innerHTML = '<span class="label">Сейчас играет</span> — Диджей';
      } else {
        nowPlaying.innerHTML = '<span class="label">Сейчас играет</span> — ' + (artist && title ? artist + ' — ' + title : '…');
      }
    }

    function updateEqualizer(freqData) {
      if (!freqData || freqData.length === 0) return;
      const step = Math.floor(freqData.length / BAR_COUNT);
      bars.forEach((bar, i) => {
        const idx = Math.min(i * step, freqData.length - 1);
        const val = freqData[idx] || 0;
        const h = Math.max(6, 8 + (val / 255) * 70);
        bar.style.height = h + 'px';
      });
    }

    function idleEqualizer() {
      const t = Date.now() / 200;
      bars.forEach((bar, i) => {
        const wave = Math.sin(t + i * 0.3) * 0.5 + 0.5;
        const h = 8 + wave * 25;
        bar.style.height = h + 'px';
      });
      animationId = requestAnimationFrame(idleEqualizer);
    }

    function stopIdleEqualizer() {
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }
    }

    function runEqualizerLoop() {
      if (!analyser || muted) return;
      const data = new Uint8Array(analyser.frequencyBinCount);
      function tick() {
        if (!playing || muted) return;
        analyser.getByteFrequencyData(data);
        updateEqualizer(data);
        animationId = requestAnimationFrame(tick);
      }
      tick();
    }

    function revokeUrl(url) {
      if (url) try { URL.revokeObjectURL(url); } catch (_) {}
    }

    async function startPlayback() {
      if (playing && !muted) return;
      if (muted && currentAudio) {
        muted = false;
        playBtn.textContent = '■';
        playBtn.title = 'Остановить';
        currentAudio.play();
        runEqualizerLoop();
        return;
      }
      playing = true;
      muted = false;
      playBtn.textContent = '■';
      playBtn.title = 'Остановить';
      stopIdleEqualizer();
      await preloadNext();
      playPreloaded();
    }

    function stopPlayback() {
      muted = true;
      playBtn.textContent = '▶';
      playBtn.title = 'Включить';
      if (currentAudio) {
        currentAudio.pause();
      }
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }
      idleEqualizer();
    }

    playBtn.onclick = () => {
      if (playing && !muted) {
        stopPlayback();
      } else {
        startPlayback();
      }
    };

    async function preloadNext() {
      while (playing) {
        try {
          const res = await fetch('/api/next');
          if (res.status === 204 || res.status === 404) {
            await new Promise(r => setTimeout(r, 500));
            continue;
          }
          if (!res.ok) {
            await new Promise(r => setTimeout(r, 1000));
            continue;
          }
          const type = res.headers.get('X-Segment-Type') || 'track';
          const artist = res.headers.get('X-Artist') || '';
          const title = res.headers.get('X-Title') || '';
          const blob = await res.blob();
          preloaded = { url: URL.createObjectURL(blob), type, artist, title };
          return;
        } catch (e) {
          await new Promise(r => setTimeout(r, 500));
        }
      }
    }

    function connectAudioToAnalyser(audio) {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        analyser.smoothingTimeConstant = 0.6;
        analyser.connect(audioContext.destination);
      }
      if (currentSource) currentSource.disconnect();
      currentSource = audioContext.createMediaElementSource(audio);
      currentSource.connect(analyser);
    }

    function playPreloaded() {
      if (!playing) return;
      if (!preloaded) {
        setTimeout(playPreloaded, 100);
        return;
      }
      const { url, type, artist, title } = preloaded;
      preloaded = null;
      preloadNext();

      const audio = new Audio(url);
      currentAudio = audio;

      audio.onended = () => {
        revokeUrl(url);
        if (playing && !muted) playPreloaded();
      };
      audio.onerror = () => {
        revokeUrl(url);
        if (playing && !muted) playPreloaded();
      };

      if (playing && !muted) {
        connectAudioToAnalyser(audio);
        if (audioContext.state === 'suspended') {
          audioContext.resume();
        }
        setNowPlaying(type, artist, title);
        audio.play();
        runEqualizerLoop();
      }
    }

    if (!playing) idleEqualizer();
  </script>
</body>
</html>
