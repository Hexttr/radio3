<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <link rel="icon" href="data:,">
  <title>NAVO RADIO</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      color: #e8e8e8;
    }
    .container {
      text-align: center;
      padding: 1.5rem 2rem;
      width: 100%;
      max-width: 900px;
    }
    .eq-wrap {
      width: 100%;
      align-self: stretch;
      position: relative;
    }
    h1 {
      font-size: 3.5rem;
      font-weight: 700;
      margin: 0 0 2rem;
      letter-spacing: 0.15em;
      color: #a855f7;
      text-shadow: 0 0 30px rgba(168, 85, 247, 0.4);
    }
    .eq-wrap {
      position: relative;
      width: 100%;
      height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 1.5rem;
    }
    .equalizer {
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: 3px;
      width: 100%;
      height: 80px;
      padding: 0 2rem;
    }
    .eq-bar {
      flex: 1;
      min-width: 6px;
      max-width: 24px;
      height: 8px;
      background: linear-gradient(to top, #7c3aed, #a855f7);
      border-radius: 4px 4px 0 0;
      transition: height 0.05s ease-out;
    }
    .play-btn {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 72px;
      height: 72px;
      border: none;
      border-radius: 50%;
      background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(168, 85, 247, 0.5), 0 0 0 4px rgba(168, 85, 247, 0.2);
      transition: transform 0.2s, box-shadow 0.2s;
      z-index: 2;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .play-btn:hover {
      transform: translate(-50%, -50%) scale(1.08);
      box-shadow: 0 6px 28px rgba(168, 85, 247, 0.6);
    }
    .play-btn:active {
      transform: translate(-50%, -50%) scale(0.98);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>NAVO RADIO</h1>
  </div>
  <div class="eq-wrap">
    <div class="equalizer" id="equalizer"></div>
    <button id="playBtn" class="play-btn" title="Включить">▶</button>
  </div>
  <div class="container"></div>
  <script>
    const playBtn = document.getElementById('playBtn');
    const equalizer = document.getElementById('equalizer');

    const BAR_COUNT = 32;
    const STREAM_URL = '/live?nocache=1';
    let useFallback = false;
    let playing = false;
    let muted = false;
    let currentAudio = null;
    let audioContext = null;
    let analyser = null;
    let currentSource = null;
    let animationId = null;

    for (let i = 0; i < BAR_COUNT; i++) {
      const bar = document.createElement('div');
      bar.className = 'eq-bar';
      bar.dataset.i = i;
      equalizer.appendChild(bar);
    }
    const bars = equalizer.querySelectorAll('.eq-bar');

    function updateEqualizer(freqData) {
      if (!freqData || freqData.length === 0) return;
      const step = Math.floor(freqData.length / BAR_COUNT);
      bars.forEach((bar, i) => {
        const idx = Math.min(i * step, freqData.length - 1);
        const val = freqData[idx] || 0;
        const h = Math.max(6, 8 + (val / 255) * 70);
        bar.style.height = h + 'px';
      });
    }

    function idleEqualizer() {
      const t = Date.now() / 200;
      bars.forEach((bar, i) => {
        const wave = Math.sin(t + i * 0.3) * 0.5 + 0.5;
        const h = 8 + wave * 25;
        bar.style.height = h + 'px';
      });
      animationId = requestAnimationFrame(idleEqualizer);
    }

    function stopIdleEqualizer() {
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }
    }

    function runEqualizerLoop() {
      if (!analyser || muted) return;
      const data = new Uint8Array(analyser.frequencyBinCount);
      let zeroFrames = 0;
      function tick() {
        if (!playing || muted) return;
        analyser.getByteFrequencyData(data);
        const allZeros = data.every(v => v === 0);
        if (allZeros && zeroFrames++ > 10) {
          updateEqualizerSimulated();
        } else {
          if (!allZeros) zeroFrames = 0;
          updateEqualizer(data);
        }
        animationId = requestAnimationFrame(tick);
      }
      tick();
    }

    function updateEqualizerSimulated() {
      const t = Date.now() / 80;
      bars.forEach((bar, i) => {
        const wave = Math.sin(t + i * 0.4) * 0.5 + 0.5;
        const noise = Math.sin(t * 2.3 + i) * 0.2 + 0.8;
        const h = Math.max(8, 12 + (wave * noise) * 60);
        bar.style.height = h + 'px';
      });
    }

    function createAndConnectAudio() {
      const audio = new Audio(STREAM_URL);
      currentAudio = audio;
      let retryCount = 0;
      let stalledTimer = null;

      audio.onerror = () => {
        if (playing && currentAudio === audio && retryCount < 5) {
          retryCount++;
          setTimeout(() => {
            if (playing && currentAudio === audio) {
              audio.src = STREAM_URL + '&t=' + Date.now();
              audio.play().catch(() => {});
            }
          }, 2000);
        }
      };
      audio.onplaying = () => { retryCount = 0; if (stalledTimer) clearTimeout(stalledTimer); stalledTimer = null; };
      audio.onended = () => {
        if (playing && currentAudio === audio) {
          createAndConnectAudio();
        }
      };
      audio.onstalled = () => {
        if (!playing || currentAudio !== audio) return;
        if (stalledTimer) clearTimeout(stalledTimer);
        stalledTimer = setTimeout(() => {
          stalledTimer = null;
          if (playing && currentAudio === audio && audio.readyState < 3) {
            createAndConnectAudio();
          }
        }, 8000);
      };

      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        analyser.smoothingTimeConstant = 0.6;
        analyser.connect(audioContext.destination);
      }
      if (currentSource) currentSource.disconnect();
      currentSource = audioContext.createMediaElementSource(audio);
      currentSource.connect(analyser);

      const startPlayback = () => {
        audio.play();
        runEqualizerLoop();
      };
      if (audioContext.state === 'suspended') {
        audioContext.resume().then(startPlayback).catch(startPlayback);
      } else {
        startPlayback();
      }
    }

    function startPlayback() {
      if (playing && !muted) return;
      if (muted && currentAudio) {
        muted = false;
        playBtn.textContent = '■';
        playBtn.title = 'Остановить';
        currentAudio.play();
        runEqualizerLoop();
        return;
      }
      playing = true;
      muted = false;
      playBtn.textContent = '■';
      playBtn.title = 'Остановить';
      stopIdleEqualizer();
      createAndConnectAudio();
    }

    function stopPlayback() {
      muted = true;
      playBtn.textContent = '▶';
      playBtn.title = 'Включить';
      if (currentAudio) {
        currentAudio.pause();
      }
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }
      idleEqualizer();
    }

    playBtn.onclick = () => {
      if (playing && !muted) {
        stopPlayback();
      } else {
        startPlayback();
      }
    };

    if (!playing) idleEqualizer();
  </script>
</body>
</html>
